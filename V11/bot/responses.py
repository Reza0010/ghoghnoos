# -*- coding: utf-8 -*-
from typing import Union, Dict, Any, Optional
import re
from decimal import Decimal

# ====================================================================
# ุชูุธูุงุช ุงุณุชฺฉุฑูุง (Stickers Config)
# ====================================================================
# ุงู ุขุฏโูุง ุฑุง ูโุชูุงูุฏ ุงุฒ ุทุฑู ุฑุจุงุช @idstickerbot ุจู ุฏุณุช ุขูุฑุฏ
STICKERS: Dict[str, str] = {
    "welcome": "",      # ุงุณุชฺฉุฑ ุฎูุดโุขูุฏฺฏู
    "success": "",      # ุชฺฉ ุณุจุฒ / ุซุจุช ูููู
    "shipping": "",     # ูุงุดู ูพุณุช
    "error": "",        # ุนูุงูุช ุฎุทุง
    "sad": "",          # ุณุจุฏ ุฎุงู
    "cart": "",         # ุขฺฉูู ุณุจุฏ ุฎุฑุฏ
}

# ====================================================================
# ุชูุงุจุน ฺฉูฺฉ (Helpers) - ุจุฑุง ุฒุจุง ู ูุธู ูุชูู
# ====================================================================
def format_price(amount: Union[int, float, str, Decimal, None]) -> str:
    """
    ูุฑูุชโุจูุฏ ููุช ุจู ุตูุฑุช ณ ุฑูู ณ ุฑูู ุจุง ูุงุญุฏ ุชููุงู.
    """
    try:
        if amount is None or str(amount) == "0":
            return "<b>0</b> ุชููุงู"
        
        # ุชุจุฏู Decimal ุง String ุจู ุนุฏุฏ ุตุญุญ ุจุฑุง ุญุฐู ุงุนุดุงุฑ
        val = int(float(amount))
        return f"<b>{val:,}</b> ุชููุงู"
    except (ValueError, TypeError):
        return "<b>0</b> ุชููุงู"

def get_divider() -> str:
    """ุฌุฏุงฺฉููุฏู ฺฏุฑุงูฺฉ ุจุฑุง ุชูฺฉฺฉ ุจุฎุดโูุง ูพุงู"""
    return "\nโโโโโโโโโโโโโโ\n"

def get_progress_bar(current_step: int, total_steps: int = 3) -> str:
    """ุงุฌุงุฏ ููุงุฑ ูพุดุฑูุช ุจุตุฑ ุจุฑุง ูุฑุงุญู ุฎุฑุฏ"""
    filled = "๐ฉ"
    empty = "โฌ"
    bar = ""
    for i in range(1, total_steps + 1):
        if i < current_step: bar += filled
        elif i == current_step: bar += "๐"
        else: bar += empty
    return f"<b>ูุฑุญูู {current_step} ุงุฒ {total_steps}</b>\n{bar}\n"

def get_tracking_timeline(status: str) -> str:
    """ูููุฏุงุฑ ูุถุนุช ุณูุงุฑุด (Timeline) ุจุง ุงููุฌโูุง ูุฑุชุจุท"""
    steps = {
        "pending_payment": ("โณ", "โฝ๏ธ", "โฝ๏ธ", "โฝ๏ธ"), # ุฏุฑ ุงูุชุธุงุฑ ูพุฑุฏุงุฎุช
        "approved":        ("โ", "โ๏ธ", "โฝ๏ธ", "โฝ๏ธ"), # ุชุงุฏ ุดุฏู/ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ
        "paid":            ("โ", "โ", "๐ฆ", "โฝ๏ธ"), # ูพุฑุฏุงุฎุช ุดุฏู/ุจุณุชูโุจูุฏ
        "shipped":         ("โ", "โ", "โ", "๐"), # ุชุญูู ูพุณุช ุดุฏู
        "rejected":        ("โ", "โ", "โ", "โ"),    # ูุบู ุดุฏู
    }
    s = steps.get(status, ("โฝ๏ธ", "โฝ๏ธ", "โฝ๏ธ", "โฝ๏ธ"))
    timeline = (
        f"{s[0]} ุซุจุช ุณูุงุฑุด\n"
        f"  โ {s[1]} ุชุงุฏ ูุงู\n"
        f"    โ {s[2]} ุขูุงุฏูโุณุงุฒ\n"
        f"      โ {s[3]} ุชุญูู ุจู ูพุณุช"
    )
    return timeline

def format_dynamic_text(template: str, user_data: Dict[str, Any]) -> str:
    """
    ุฌุงฺฏุฒู ููุดููุฏ ูุชุบุฑูุง ุฏุฑ ูุชู.
    ูพุดุชุจุงู ุงุฒ ุชฺฏโูุง: {user_name}, {shop_name}, {order_count}, {total_spent} ู ุบุฑู
    """
    if not template:
        return ""

    # ููุงุฏุฑ ูพุดโูุฑุถ ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุง ุฏุฑ ุตูุฑุช ูุจูุฏู ุฏุงุฏู
    replacements = {
        "{user_name}": str(user_data.get("user_name") or "ฺฉุงุฑุจุฑ"),
        "{shop_name}": str(user_data.get("shop_name") or "ูุฑูุดฺฏุงู ูุง"),
        "{order_count}": str(user_data.get("order_count", 0)),
        "{total_spent}": format_price(user_data.get("total_spent", 0)),
        "{discount}": str(user_data.get("discount", "0")),
    }

    # ุฌุงฺฏุฒู ุงูู ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏ replace
    text = template
    for key, value in replacements.items():
        text = text.replace(key, value)
    
    return text

# ====================================================================
# ูพุงูโูุง ุณุณุชู ู ุนููู
# ====================================================================
ERROR_MESSAGE = (
    "โ๏ธ <b>ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ุฑุฎ ุฏุงุฏ.</b>\n"
    "ูุทูุงู ูุญุธุงุช ุฏฺฏุฑ ุชูุงุด ฺฉูุฏ ุง ุจุง ุฏุณุชูุฑ /start ูุฌุฏุฏุงู ุงูุชุญุงู ฺฉูุฏ."
)
UNKNOWN_COMMAND = "๐ค ูุชูุฌู ุงู ุฏุณุชูุฑ ูุดุฏู. ูุทูุง ุงุฒ ููู ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ."
LOADING = "โณ <i>ุฏุฑ ุญุงู ุฏุฑุงูุช ุงุทูุงุนุงุช...</i>"
WELCOME_MESSAGE = "ุณูุงู {user_name} ุนุฒุฒ ๐\nุจู ูุฑูุดฺฏุงู {shop_name} ุฎูุด ุขูุฏุฏ."

# ====================================================================
# ุจุฑฺุณุจ ุฏฺฉููโูุง (Button Labels)
# ====================================================================
PRODUCTS_BUTTON = "๐ ูุญุตููุงุช"
SEARCH_BUTTON = "๐ ุฌุณุชุฌู"
SPECIAL_OFFERS_BUTTON = "๐ฅ ูพุดููุงุฏ ูฺู"
CART_BUTTON = "๐ ุณุจุฏ ุฎุฑุฏ"
TRACK_ORDER_BUTTON = "๐ฆ ูพฺฏุฑ ุณูุงุฑุด"
SUPPORT_BUTTON = "๐ ูพุดุชุจุงู"
ABOUT_US_BUTTON = "โน๏ธ ุฏุฑุจุงุฑู ูุง"
BACK_BUTTON = "๐ ุจุงุฒฺฏุดุช"
MAIN_MENU_BUTTON = "๐ ุตูุญู ุงุตู"
USER_PROFILE_BUTTON = "๐ค ุญุณุงุจ ฺฉุงุฑุจุฑ"

# ====================================================================
# ูุญุตููุงุช ู ุฌุณุชุฌู
# ====================================================================
CATEGORY_SELECT = "๐ <b>ูุทูุงู ุฏุณุชูโุจูุฏ ููุฑุฏ ูุธุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:</b>"
PRODUCT_LIST = "๐ <b>ูุณุช ูุญุตููุงุช ฺฏุฑูู:</b>\n{breadcrumbs}"
PRODUCT_DETAILS = """
โจ <b>{name}</b>
{divider}
๐ <b>ุชูุถุญุงุช:</b>
{description}

๐ท <b>ุจุฑูุฏ:</b> <code>{brand}</code>
๐ฆ <b>ูุถุนุช:</b> {stock_status}
{divider}
๐ฐ <b>ููุช:</b> {price_formatted}
{cart_preview}
"""
SEARCH_PROMPT = "๐ <b>ฺู ูุญุตูู ูุงุฒ ุฏุงุฑุฏุ</b>\nูุงู ูุญุตููุ ุจุฑูุฏ ุง ุชฺฏ ููุฑุฏ ูุธุฑ ุฑุง ุจููุณุฏ:"
SEARCH_NO_RESULT = "โ <b>ูุชุฌูโุง ุงูุช ูุดุฏ!</b>\nูุทูุงู ฺฉููุงุช ฺฉูุฏ ุฏฺฏุฑ ุฑุง ุงูุชุญุงู ฺฉูุฏ."
SEARCH_RESULT_TITLE = "๐ ูุชุงุฌ ุฌุณุชุฌู ุจุฑุง: <code>{query}</code>"

# ====================================================================
# ุณุจุฏ ุฎุฑุฏ ู ุนูุงููโููุฏ
# ====================================================================
CART_EMPTY = "๐ <b>ุณุจุฏ ุฎุฑุฏ ุดูุง ุฎุงู ุงุณุช!</b>\nูโุชูุงูุฏ ุงุฒ ุจุฎุด ูุญุตููุงุช ฺฉุงูุง ุงุถุงูู ฺฉูุฏ."
CART_TITLE = "๐ <b>ูุณุช ุฎุฑุฏ ุดูุง:</b>\n"
CART_ITEM_ROW = "๐ธ <b>{name}</b>\nโ ๐ข {quantity} ุนุฏุฏ ร {total_formatted}\n"
CART_TOTAL = "โโโโโโโโโโโโโโโโ\n๐ต <b>ูุจูุบ ูุงุจู ูพุฑุฏุงุฎุช: {total_amount_formatted}</b>"
ADDED_TO_CART = "โ ูุญุตูู ุจู ุณุจุฏ ุฎุฑุฏ ุงุถุงูู ุดุฏ."
CART_CLEARED = "๐ ุณุจุฏ ุฎุฑุฏ ุจุง ููููุช ุฎุงู ุดุฏ."
FAV_ADDED = "โค๏ธ ุจู ูุณุช ุนูุงููโููุฏโูุง ุงุถุงูู ุดุฏ."
FAV_REMOVED = "๐ ุงุฒ ูุณุช ุนูุงููโููุฏโูุง ุญุฐู ุดุฏ."
FAV_EMPTY = "๐ ูุณุช ุนูุงููโููุฏโูุง ุดูุง ุฎุงู ุงุณุช."
NOTIFY_SUCCESS = "๐ <b>ุฏุฑุฎูุงุณุช ุซุจุช ุดุฏ!</b>\nุจู ูุญุถ ููุฌูุฏ ุดุฏู ฺฉุงูุงุ ุงุทูุงุนโุฑุณุงู ูโุดูุฏ."
NOTIFY_ALREADY = "โ๏ธ ุดูุง ูุจูุงู ุฏุฑ ูุณุช ุงูุชุธุงุฑ ุงู ฺฉุงูุง ุจูุฏุฏ."

# ====================================================================
# ุญุณุงุจ ฺฉุงุฑุจุฑ ู ุณูุงุจู (User Account)
# ====================================================================
USER_PROFILE_DASHBOARD = """
๐ค <b>ูพุฑููุงู ฺฉุงุฑุจุฑ</b>
{divider}
๐ ฺฉุฏ ฺฉุงุฑุจุฑ: <code>{user_id}</code>
๐ค ูุงู: <b>{full_name}</b>
๐ฑ ููุจุงู: <code>{phone}</code>

๐ <b>ุขูุงุฑ ุฎุฑุฏ:</b>
๐ ุนุถูุช: <code>{join_date}</code>
๐ฆ ุณูุงุฑุดุงุช: <b>{order_count} ููุฑุฏ</b>
๐ฐ ูุฌููุน ุฎุฑุฏ: <b>{total_spent}</b>
{divider}
๐ ุชูุธูุงุช ุญุณุงุจ:
"""
ORDER_HISTORY_LIST = """
๐ฆ <b>ุชุงุฑุฎฺู ุณูุงุฑุดุงุช ุงุฎุฑ</b>
{divider}
{orders_text}
{divider}
<i>ุจุฑุง ุฌุฒุฆุงุช ุจุดุชุฑ ุฑู ูุฑ ุณูุงุฑุด ฺฉูฺฉ ฺฉูุฏ.</i>
"""
ADDRESS_MANAGEMENT_TITLE = "๐ <b>ูุฏุฑุช ุขุฏุฑุณโูุง</b>\nุจุฑุง ุญุฐูุ ุฑู ุถุฑุจุฏุฑ ูุฑูุฒ ฺฉูุงุฑ ุขุฏุฑุณ ฺฉูฺฉ ฺฉูุฏ:"

# ====================================================================
# ูุฑุขูุฏ ฺฺฉโุงูุช (ุซุจุช ุณูุงุฑุด)
# ====================================================================
def get_checkout_address(has_saved_addr: bool = False) -> str:
    msg = f"{get_progress_bar(1)}\n๐ <b>ูุฑุญูู ุงูู: ุขุฏุฑุณ ุงุฑุณุงู</b>\n"
    if has_saved_addr:
        msg += "ูโุชูุงูุฏ ุงุฒ ูุณุช ุขุฏุฑุณโูุง ูุจู ุงูุชุฎุงุจ ฺฉูุฏ ุง ุขุฏุฑุณ ุฌุฏุฏ ุชุงูพ ฺฉูุฏ:"
    else:
        msg += "ูุทูุงู ุขุฏุฑุณ ุฏูู ูพุณุช ุฎูุฏ ุฑุง (ุงุณุชุงูุ ุดูุฑุ ุฎุงุจุงู ู ูพูุงฺฉ) ูุงุฑุฏ ฺฉูุฏ:"
    return msg

def get_checkout_phone() -> str:
    return f"{get_progress_bar(2)}\n๐ฑ <b>ูุฑุญูู ุฏูู: ุดูุงุฑู ุชูุงุณ</b>\nูุทูุงู ุดูุงุฑู ููุจุงู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ ุง ุงุฒ ุฏฺฉูู ุฒุฑ ุจุฑุง ุงุฑุณุงู ุณุฑุน ุงุณุชูุงุฏู ฺฉูุฏ:"

def get_checkout_payment(total: Any, shipping_cost: str, final_total: Any, card_number: str, card_owner: str) -> str:
    div = get_divider()
    return (
        f"{get_progress_bar(3)}\n"
        f"๐งพ <b>ูพุดโูุงฺฉุชูุฑ ููุง</b>\n"
        f"{div}"
        f"๐ ูุจูุบ ฺฉุงูุงูุง: {format_price(total)}\n"
        f"๐ต ูุฒูู ุงุฑุณุงู: <b>{shipping_cost}</b>\n"
        f"{div}"
        f"๐ณ <b>ูุจูุบ ููุง ุฌูุช ูุงุฑุฒ:</b>\n"
        f"๐ {format_price(final_total)}\n\n"
        f"๐ฆ <b>ุงุทูุงุนุงุช ฺฉุงุฑุช ุจุงูฺฉ:</b>\n"
        f"ุดูุงุฑู ฺฉุงุฑุช: <code>{card_number}</code>\n"
        f"ุจู ูุงู: <b>{card_owner}</b>\n\n"
        f"๐ธ <b>ูุทูุงู ูพุณ ุงุฒ ูุงุฑุฒุ ุชุตูุฑ ูุด ุฑุง ูููุฌุง ุงุฑุณุงู ฺฉูุฏ.</b>"
    )

ORDER_CONFIRMATION = """
๐ <b>ุณูุงุฑุด ุดูุง ุจุง ููููุช ุซุจุช ุดุฏ!</b> ๐
๐ ฺฉุฏ ูพฺฏุฑ: <code>{order_id}</code>
{divider}
{timeline}
{divider}
<i>ุจู ูุญุถ ุชุบุฑ ูุถุนุชุ ุงุทูุงุนโุฑุณุงู ุงูุฌุงู ุฎูุงูุฏ ุดุฏ.</i>
"""

# ====================================================================
# ุตูุญุงุช ุซุงุจุช (Static Pages)
# ====================================================================
SUPPORT_TEXT = """
๐ <b>ูพุดุชุจุงู ูุฑูุดฺฏุงู</b>
ุจุฑุง ุงุฑุชุจุงุท ูุณุชูู ุจุง ฺฉุงุฑุดูุงุณุงู ูุง ุฑู ุขุฏ ุฒุฑ ฺฉูฺฉ ฺฉูุฏ:
๐ {support_id}
{divider}
โฐ ุณุงุนุช ูพุงุณุฎฺฏู: ฑฐ ุตุจุญ ุงู ฑฐ ุดุจ
"""

ABOUT_US_TEXT = """
โน๏ธ <b>ุฏุฑุจุงุฑู ูุฑูุดฺฏุงู {shop_name}</b>
๐ <b>ุขุฏุฑุณ:</b> {address}
๐ <b>ุชููู:</b> <code>{phone}</code>
{divider}
ููููู ุงุฒ ุญุณู ุงูุชุฎุงุจ ู ุงุนุชูุงุฏ ุดูุง! โค๏ธ
"""